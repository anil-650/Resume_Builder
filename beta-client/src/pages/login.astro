---
//visuals
import { Icon } from "astro-icon"
import Links from "../components/Links.astro"
// switching layout of input

import AuthInput from "../components/Auth_Input.astro"
import Button from "../components/Button.astro"
import BaseLayout from "../layouts/BaseLayout.astro"
import { cookieOpt } from "../utils/cookie.js"
// scripts
import { loginUser } from "../utils/auth"

// CHECK FOR LOGIN COOKIE
let cookie;
let errors = null

if (Astro.cookies.has('isLoggedin')){
    return Astro.redirect('/user')
}

// SET COOKIE FOR LOGGED IN USER
if (Astro.request.method === 'POST') {
    try {
       const data = await Astro.request.formData();
       console.log(data.get('email'))
       const recive = await loginUser(data);
       if(recive.ok){
       const data = await recive.json()
           cookie = data.token;
           console.log(cookie)
           Astro.cookies.set('isLoggedin', 'true', cookieOpt)
           Astro.cookies.set('token', cookie, cookieOpt)

           return Astro.redirect('/user');
        }else if(recive.status >= 400 && recive.status <= 499){
            const data = await recive.json()

            // DEBUG
            console.log(`this is error data from `)
            console.dir(data)

            errors = data.error
        }else if (recive.status >= 500 && recive.status <= 599){
            return Astro.redirect('/500')
        }
    } catch (error ) {
        if (error instanceof Error){
            console.error(error.message)
        }
    }
}
---
<BaseLayout title="Login Page" classes="bg-slate-100">
<div class="flex-1 flex justify-center items-center">
    <div
  class="container mb-6 mx-auto max-w-xs md:max-w-md lg:max-w-lg w-full rounded-lg bg-white p-6 shadow-lg">
   <div class="flex flex-col items-center mb-2">
   <Icon name="mdi:key-variant" class="w-20 h-20 text-gray-500 center" />
  <h2 class="font-bold text-xl mb-12 text-gray-600">Sign In</h2>

                    { ( errors !== null) &&
                    <p class="warning">{errors}</p>
                    }
   </div>
  <form method="POST">
    <div class="relative space-y-5 mb-12" data-te-input-wrapper-init>
        <AuthInput icon="mdi:email-fast" lname="Email:" name="email" id="useremail" input_type="email" required/>
        <AuthInput icon="mdi:key-chain-variant" lname="Password:" name="password" id="userpassword" input_type="password" minlength="6"  required/>
    </div>
    <Button type="submit" name="Login" classes="bg-blue-500 hover:bg-blue-600" />
    <Links href="/register" text="Don't have an account ? Sign Up" classes="text-blue-500 visited:text-purple-600 hover:underline hover:font-medium "/>
    <p></p>
    <Links href="/forgotpassword" text="forgot password ?" classes="text-blue-500 visited:text-purple-600 hover:underline hover:font-medium "/>
  </form>
</div>
 </div>
</BaseLayout>
<style>
    .warning {
        @apply text-center text-base text-red-400 font-bold pb-5 ;
    }
</style>
